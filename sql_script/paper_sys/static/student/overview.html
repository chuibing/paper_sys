<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>论文概览分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.0.0/dist/echarts-wordcloud.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            neutral: '#86909C',
            light: '#F2F3F5',
            dark: '#1D2129'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .sidebar-item {
        @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer;
      }
      .sidebar-item.active {
        @apply bg-primary/10 text-primary font-medium;
      }
      .sidebar-item:hover:not(.active) {
        @apply bg-gray-100;
      }
      .card {
        @apply bg-white rounded-xl shadow-sm border border-gray-200 p-5 transition-all hover:shadow-md;
      }
      .chart-container {
        @apply w-full h-[400px] mt-4;
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 text-dark h-screen flex overflow-hidden">
  <!-- 左侧导航栏（移除浏览记录，保留控制台预留） -->
  <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 transition-all duration-300 ease-in-out">
    <div class="p-5 border-b border-gray-200">
      <h1 class="text-xl font-bold text-primary flex items-center gap-2">
        <i class="fa fa-graduation-cap"></i>
        <span>学术资源管理系统</span>
      </h1>
    </div>

    <nav class="p-4">
      <h2 class="text-xs uppercase text-neutral font-semibold mb-3 px-4">控制台</h2>
      <ul class="space-y-1">
        <li>
          <a href="/student/overview" class="sidebar-item active">
            <i class="fa fa-bar-chart w-5 text-center"></i>
            <span>论文概览</span>
          </a>
        </li>
        <!-- 控制台预留项（后续拓展） -->
        <li>
          <a href="#" class="sidebar-item text-neutral cursor-not-allowed">
            <i class="fa fa-cog w-5 text-center"></i>
            <span>控制台拓展</span>
          </a>
        </li>
      </ul>

      <h2 class="text-xs uppercase text-neutral font-semibold mb-3 px-4 mt-8">其他功能</h2>
      <ul class="space-y-1">
        <li>
          <a href="#" class="sidebar-item text-neutral cursor-not-allowed">
            <i class="fa fa-star-o w-5 text-center"></i>
            <span>收藏论文</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- 主内容区 -->
  <main class="flex-1 flex flex-col overflow-hidden">
    <!-- 顶部导航 -->
    <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6">
      <h2 class="text-lg font-semibold">论文数据分析概览</h2>
      <div class="flex items-center gap-4">
        <button class="text-neutral hover:text-primary transition-colors" id="refresh-data">
          <i class="fa fa-refresh text-lg"></i>
        </button>
        <div class="flex items-center gap-2">
          <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-8 h-8 rounded-full object-cover border border-gray-200">
          <span class="text-sm font-medium" id="current-username">当前用户</span>
        </div>
      </div>
    </header>

    <!-- 内容区域（仅保留核心图表，无预填数据） -->
    <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
      <!-- 数据概览卡片（从接口动态获取） -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-neutral text-sm">总论文数</p>
              <h3 class="text-2xl font-bold text-primary" id="total-papers">--</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
              <i class="fa fa-file-text-o text-primary text-xl"></i>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-neutral text-sm">分类数量</p>
              <h3 class="text-2xl font-bold text-secondary" id="total-categories">--</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-secondary/10 flex items-center justify-center">
              <i class="fa fa-tags text-secondary text-xl"></i>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-neutral text-sm">年份跨度</p>
              <h3 class="text-2xl font-bold text-orange-500" id="year-range">--</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-orange-50 flex items-center justify-center">
              <i class="fa fa-calendar text-orange-500 text-xl"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- 图表区域（仅保留分类柱状图、年份折线图） -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- 分类柱状图 -->
        <div class="card">
          <h3 class="font-medium mb-2">论文分类分布</h3>
          <div class="chart-container" id="category-chart">
            <div class="flex items-center justify-center h-full text-neutral">
              <i class="fa fa-spinner fa-spin text-primary text-2xl mr-3"></i>
              <span>加载分类数据...</span>
            </div>
          </div>
        </div>
        <!-- 年份折线图 -->
        <div class="card">
          <h3 class="font-medium mb-2">论文发表年份趋势</h3>
          <div class="chart-container" id="year-chart">
            <div class="flex items-center justify-center h-full text-neutral">
              <i class="fa fa-spinner fa-spin text-primary text-2xl mr-3"></i>
              <span>加载年份数据...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 词云区域（预留，暂不显示） -->
      <div class="card mb-6 hidden">
        <h3 class="font-medium mb-2">论文关键词词云</h3>
        <div class="chart-container" id="wordcloud-chart"></div>
      </div>
    </div>
  </main>

  <script>
    // DOM元素
    const totalPapersEl = document.getElementById('total-papers');
    const totalCategoriesEl = document.getElementById('total-categories');
    const yearRangeEl = document.getElementById('year-range');
    const refreshBtn = document.getElementById('refresh-data');
    const currentUsernameEl = document.getElementById('current-username');

    // 初始化ECharts实例
    let categoryChart = null;
    let yearChart = null;

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadUserInfo();
      initCharts();
      loadAllStatsData();
      refreshBtn.addEventListener('click', loadAllStatsData);
    });

    // 获取用户信息（从localStorage）
    function loadUserInfo() {
      const userInfo = localStorage.getItem('userInfo');
      if (userInfo) {
        const user = JSON.parse(userInfo);
        currentUsernameEl.textContent = user.real_name || user.username;
      }
    }

    // 初始化图表实例
    function initCharts() {
      categoryChart = echarts.init(document.getElementById('category-chart'));
      yearChart = echarts.init(document.getElementById('year-chart'));
      // 窗口自适应
      window.addEventListener('resize', () => {
        categoryChart && categoryChart.resize();
        yearChart && yearChart.resize();
      });
    }

    // 加载所有统计数据（分类+年份）
    async function loadAllStatsData() {
      try {
        showToast('正在加载数据...');
        // 并行请求分类和年份数据
        const [categoryRes, yearRes] = await Promise.all([
          fetch('/student/api/stats/category', {
            method: 'GET',
            credentials: 'include'
          }),
          fetch('/student/api/stats/year', {
            method: 'GET',
            credentials: 'include'
          })
        ]);

        // 检查响应状态
        if (!categoryRes.ok || !yearRes.ok) {
          throw new Error(`接口请求失败：分类(${categoryRes.status}) / 年份(${yearRes.status})`);
        }

        // 解析数据
        const categoryData = await categoryRes.json();
        const yearData = await yearRes.json();

        // 校验返回码
        if (categoryData.code !== 200 || yearData.code !== 200) {
          throw new Error(`数据返回异常：${categoryData.message || yearData.message}`);
        }

        // 更新概览卡片
        updateOverviewCards(categoryData.data, yearData.data);
        // 渲染图表
        renderCategoryChart(categoryData.data);
        renderYearChart(yearData.data);

        showToast('数据加载成功');
      } catch (error) {
        console.error('加载统计数据失败:', error);
        showToast(`加载失败：${error.message}`, 'error');
        // 清空图表加载状态
        emptyChartState('category-chart', '分类数据加载失败');
        emptyChartState('year-chart', '年份数据加载失败');
        // 重置概览卡片
        totalPapersEl.textContent = '--';
        totalCategoriesEl.textContent = '--';
        yearRangeEl.textContent = '--';
      }
    }

    // 更新概览卡片数据
    function updateOverviewCards(categoryStats, yearStats) {
      // 计算总论文数（分类数据求和）
      const totalPapers = categoryStats.categories && categoryStats.counts
        ? categoryStats.counts.reduce((sum, val) => sum + val, 0)
        : 0;
      totalPapersEl.textContent = totalPapers;

      // 分类数量
      const categoryCount = categoryStats.categories ? categoryStats.categories.length : 0;
      totalCategoriesEl.textContent = categoryCount;

      // 年份跨度
      if (yearStats.years && yearStats.years.length > 0) {
        const minYear = Math.min(...yearStats.years);
        const maxYear = Math.max(...yearStats.years);
        yearRangeEl.textContent = `${maxYear - minYear}年 (${minYear}-${maxYear})`;
      } else {
        yearRangeEl.textContent = '--';
      }
    }

    // 渲染分类柱状图
    function renderCategoryChart(data) {
      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: data.categories || [],
          axisLabel: { rotate: 15, fontSize: 12 }
        },
        yAxis: { type: 'value', name: '论文数量' },
        series: [{
          name: '论文数',
          type: 'bar',
          data: data.counts || [],
          itemStyle: {
            color: function(params) {
              const colorList = ['#165DFF', '#36CFC9', '#FF7D00', '#F53F3F', '#722ED1', '#0FC6C2', '#7BC616'];
              return colorList[params.dataIndex % colorList.length];
            }
          }
        }]
      };
      categoryChart.setOption(option);
    }

    // 渲染年份折线图
    function renderYearChart(data) {
      const option = {
        tooltip: { trigger: 'axis', formatter: '{b}年: {c}篇' },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: data.years || [],
          boundaryGap: false
        },
        yAxis: { type: 'value', name: '发表数量' },
        series: [{
          name: '发表数量',
          type: 'line',
          data: data.counts || [],
          smooth: true,
          lineStyle: { width: 3, color: '#165DFF' },
          itemStyle: { color: '#165DFF', borderWidth: 2 },
          areaStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: 'rgba(22, 93, 255, 0.3)' },
              { offset: 1, color: 'rgba(22, 93, 255, 0.05)' }
            ])
          },
          markPoint: { data: [{ type: 'max', name: '最大值' }, { type: 'min', name: '最小值' }] },
          markLine: { data: [{ type: 'average', name: '平均值' }] }
        }]
      };
      yearChart.setOption(option);
    }

    // 图表空状态
    function emptyChartState(chartId, text) {
      const el = document.getElementById(chartId);
      el.innerHTML = `<div class="flex items-center justify-center h-full text-neutral">
        <i class="fa fa-exclamation-circle text-primary text-2xl mr-3"></i>
        <span>${text}</span>
      </div>`;
      // 重新初始化图表实例
      if (chartId === 'category-chart') {
        categoryChart = echarts.init(el);
      } else if (chartId === 'year-chart') {
        yearChart = echarts.init(el);
      }
    }

    // Toast提示
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-6 right-6 px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 transition-all duration-300 transform translate-y-10 opacity-0`;

      if (type === 'success') {
        toast.classList.add('bg-green-50', 'text-green-600', 'border', 'border-green-200');
        toast.innerHTML = `<i class="fa fa-check-circle"></i><span>${message}</span>`;
      } else {
        toast.classList.add('bg-red-50', 'text-red-600', 'border', 'border-red-200');
        toast.innerHTML = `<i class="fa fa-exclamation-circle"></i><span>${message}</span>`;
      }

      document.body.appendChild(toast);
      setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 10);
      setTimeout(() => {
        toast.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }
  </script>
</body>
</html>