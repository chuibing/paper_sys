<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>个人设置 - 日程管理</title>
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      color: #333;
    }
    
    .container {
      display: flex;
      min-height: 100vh;
      padding: 20px;
      gap: 20px;
    }
    
    /* 左侧个人信息 */
    .profile-section {
      flex: 1;
      background: white;
      border-radius: 12px; /* 略微增大圆角 */
      padding: 30px 25px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); /* 增强阴影效果 */
      min-width: 300px;
      max-width: 350px;
      display: flex; /* 确保内容居中或合理布局 */
      flex-direction: column;
    }

    .profile-section h2 {
      color: #409EFF;
      margin-bottom: 25px; /* 增大标题下方间距 */
      padding-bottom: 10px;
      border-bottom: 3px solid #409EFF; /* 略微加粗分割线 */
      font-size: 22px; /* 标题字体调大 */
      text-align: center; /* 标题居中 */
    }

    .info-item {
      margin: 15px 0; /* 调整项目间距 */
      padding: 10px 0;
      background: #f0f7ff; /* 浅蓝色背景以突出每个信息块 */
      border-left: 5px solid #409EFF; /* 增加左侧蓝色指示条 */
      border-radius: 4px;
      padding-left: 15px;
    }

    .info-label {
      color: #666;
      font-size: 14px; /* 标签字体保持清晰 */
      font-weight: 500; /* 调整字重 */
      margin-bottom: 4px; /* 标签和值之间的间距 */
    }

    .info-value {
      color: #333;
      font-size: 18px; /* **重点：调大信息值字体** */
      font-weight: bold; /* 突出信息值 */
      /* padding: 8px 0; (移除原始的padding，使用新的布局) */
    }
    
    /* 右侧主内容 */
    .main-section {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* 日历容器 */
    .calendar-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* 日程表格 */
    .schedule-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    /* 表格样式 */
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      flex: 1;
    }
    
    .schedule-table th {
      background: #f8f9fa;
      padding: 12px 15px;
      text-align: left;
      font-weight: bold;
      color: #495057;
      border-bottom: 2px solid #e9ecef;
    }
    
    .schedule-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .schedule-table tr:hover {
      background: #f8f9fa;
    }
    
    /* 优先级标签 */
    .priority-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .priority-high {
      background: #fdecea;
      color: #f56c6c;
    }
    
    .priority-medium {
      background: #fcf4e8;
      color: #e6a23c;
    }
    
    .priority-low {
      background: #f0f9eb;
      color: #67c23a;
    }
    
    /* 状态标签 */
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-pending {
      background: #ecf5ff;
      color: #409EFF;
    }
    
    .status-completed {
      background: #f0f9eb;
      color: #67c23a;
    }
    
    /* 按钮组 */
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .complete-btn {
      background: #67c23a;
      color: white;
    }
    
    .complete-btn:hover {
      background: #5daf34;
    }
    
    .edit-btn {
      background: #409EFF;
      color: white;
    }
    
    .edit-btn:hover {
      background: #337ecc;
    }
    
    .delete-btn {
      background: #f56c6c;
      color: white;
    }
    
    .delete-btn:hover {
      background: #dd6161;
    }
    
    /* 添加日程按钮 */
    .add-schedule-btn {
      background: #409EFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 20px;
      align-self: flex-start;
    }
    
    .add-schedule-btn:hover {
      background: #337ecc;
    }
    
    /* 模态框样式 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      width: 500px;
      margin: 50px auto;
      border-radius: 8px;
      padding: 30px;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 30px;
    }
    
    .cancel-btn {
      background: #f0f0f0;
      color: #666;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .submit-btn {
      background: #409EFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .no-schedules {
      text-align: center;
      color: #999;
      padding: 50px 0;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* 响应式设计 */
    @media (max-width: 1024px) {
      .container {
        flex-direction: column;
      }
      
      .profile-section {
        max-width: none;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- 左侧：个人信息 -->
  <div class="profile-section">
    <h2>个人信息</h2>
    <div class="info-item">
      <div class="info-label">用户ID：</div>
      <div class="info-value" id="user-id">加载中...</div>
    </div>
    <div class="info-item">
      <div class="info-label">用户名：</div>
      <div class="info-value" id="username">加载中...</div>
    </div>
    <div class="info-item">
      <div class="info-label">真实姓名：</div>
      <div class="info-value" id="real-name">加载中...</div>
    </div>
    <div class="info-item">
      <div class="info-label">角色：</div>
      <div class="info-value" id="role">加载中...</div>
    </div>
    <div class="info-item">
      <div class="info-label">学院名称：</div>
      <div class="info-value" id="college-name">加载中...</div>
    </div>
  </div>

  <!-- 右侧：主内容 -->
  <div class="main-section">
    <!-- 日历区域 -->
    <div class "calendar-container">
      <div id="calendar"></div>
    </div>

    <!-- 日程表格区域 -->
    <div class="schedule-container">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>我的日程</h2>
        <button class="add-schedule-btn" id="addScheduleBtn">+ 添加新日程</button>
      </div>
      
      <table class="schedule-table" id="scheduleTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>标题</th>
            <th>优先级</th>
            <th>状态</th>
            <th>创建时间</th>
            <th>截止时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="scheduleTbody">
          <!-- 日程数据将通过JS动态添加 -->
        </tbody>
      </table>
      <div class="no-schedules" id="noSchedules">暂无日程安排</div>
    </div>
  </div>
</div>

<!-- 添加/编辑日程模态框 -->
<div class="modal" id="scheduleModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">添加新日程</h3>
      <button class="close-btn" id="closeModalBtn">&times;</button>
    </div>
    <form id="scheduleForm">
      <input type="hidden" id="taskId" value="">
      
      <div class="form-group">
        <label for="title">标题 *</label>
        <input type="text" id="title" required maxlength="200">
      </div>
      
      <div class="form-group">
        <label for="eventDate">日期 *</label>
        <input type="date" id="eventDate" required>
      </div>
      
      <div class="form-group">
        <label for="priority">优先级</label>
        <select id="priority">
          <option value="low">低</option>
          <option value="medium" selected>中</option>
          <option value="high">高</option>
        </select>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="cancel-btn" id="cancelBtn">取消</button>
        <button type="submit" class="submit-btn">保存</button>
      </div>
    </form>
  </div>
</div>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/zh-cn.js"></script>

<script>
  // 全局变量
  let currentUser = {};
  let currentTasks = [];
  let isEditing = false;
  let currentEditingId = null;
  
  // DOM加载完成后初始化
  document.addEventListener('DOMContentLoaded', function() {
    // 1. 加载用户信息
    loadUserInfo();
    
    // 2. 初始化日历
    initCalendar();
    
    // 3. 加载日程数据
    loadTasks();
    
    // 4. 绑定事件
    bindEvents();
  });
  
  // 加载用户信息
  async function loadUserInfo() {
    try {
      const userInfoStr = localStorage.getItem('userInfo');
      if (userInfoStr) {
        currentUser = JSON.parse(userInfoStr);
        
        // 填充用户信息到页面
        document.getElementById('user-id').textContent = currentUser.user_id || '暂无';
        document.getElementById('username').textContent = currentUser.username || '暂无';
        document.getElementById('real-name').textContent = currentUser.real_name || '暂无';
        document.getElementById('role').textContent = currentUser.role || '暂无';

        await loadColleges(); // 如果还没加载过
        const collegeName = getCollegeNameById(currentUser.college_id);
        document.getElementById('college-name').textContent = collegeName

      } else {
        console.warn('未找到用户信息，请先登录');
        // 如果没有用户信息，重定向到登录页
        window.location.href = '/login';
      }
    } catch (error) {
      console.error('加载用户信息失败:', error);
    }
  }
  
  // 获取学院列表并缓存
  async function loadColleges() {
    try {
      const response = await fetch('/user/api/colleges');
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const result = await response.json();
      if (result.code === 200) {
        collegeList = result.data; // 缓存起来，避免重复请求
        console.log('【调试】学院 API 数据:', result);
      }
    } catch (error) {
      console.error('加载学院列表失败:', error);
      collegeList = []; // 降级处理
    }
  }

  // 根据 college_id 获取学院名称
  function getCollegeNameById(collegeId) {
    if (!collegeId) return '暂无';
    
    const college = collegeList.find(c => c.college_id == collegeId); // 注意：用 == 兼容字符串/数字
    console.log('【调试】根据 college_id 获取学院名称:', college);
    return college ? college.college_name : `未知学院(ID:${collegeId})`;
  }

  // 初始化日历
  function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'zh-cn',
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: function(fetchInfo, successCallback, failureCallback) {
        // 从API获取日历事件
        fetchCalendarEvents(fetchInfo.start, fetchInfo.end)
          .then(events => successCallback(events))
          .catch(error => {
            console.error('获取日历事件失败:', error);
            failureCallback(error);
          });
      },
      eventClick: function(info) {
        // 点击事件跳转到编辑
        editTask(info.event.id);
      },
      dateClick: function(info) {
        // 点击日期添加日程
        openAddModal(info.dateStr);
      }
    });
    
    calendar.render();
    window.calendar = calendar;
  }
  
  // 获取日历事件
  async function fetchCalendarEvents(start, end) {
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    
    if (!userInfo) {
      console.warn('未找到用户信息，请先登录');
      return [];
    }
    
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/user/api/tasks/calendar/?user_id=${userInfo.user_id}&start=${start.toISOString().split('T')[0]}&end=${end.toISOString().split('T')[0]}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        return data.data;
      } else {
        console.error('获取日历事件失败:', data.message);
        return [];
      }
    } catch (error) {
      console.error('获取日历事件失败:', error);
      return [];
    }
  }
  
  // 获取优先级标签
  function getPriorityLabel(priority) {
    switch(priority) {
      case 'high': 
        return '<span class="priority-badge priority-high">高</span>';
      case 'medium': 
        return '<span class="priority-badge priority-medium">中</span>';
      case 'low': 
        return '<span class="priority-badge priority-low">低</span>';
      default: 
        return '<span class="priority-badge priority-medium">中</span>';
    }
  }
  
  // 获取状态标签
  function getStatusLabel(status) {
    if (status === 'completed') {
      return '<span class="status-badge status-completed">已完成</span>';
    } else {
      return '<span class="status-badge status-pending">待办</span>';
    }
  }
  
  // 获取优先级颜色
  function getPriorityColor(priority) {
    switch(priority) {
      case 'high': return '#f56c6c';
      case 'medium': return '#e6a23c';
      case 'low': return '#67c23a';
      default: return '#409EFF';
    }
  }
  
  // 加载任务数据
  async function loadTasks() {
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    if (!userInfo || !userInfo.user_id) {
      console.warn('未找到用户信息，请先登录');
      showNoTasks();
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const url = `/user/api/tasks?user_id=${encodeURIComponent(userInfo.user_id)}`;
      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        currentTasks = data.data || [];
        renderScheduleTable();
      } else {
        console.error('加载任务失败:', data.message);
        showNoTasks();
      }
    } catch (error) {
      console.error('加载任务失败:', error);
      showNoTasks();
    }
  }
  
  // 显示无任务提示
  function showNoTasks() {
    const tbody = document.getElementById('scheduleTbody');
    const noSchedules = document.getElementById('noSchedules');
    tbody.innerHTML = '';
    noSchedules.style.display = 'flex';
  }
  
  // 渲染任务表格
  function renderScheduleTable() {
    const tbody = document.getElementById('scheduleTbody');
    const noSchedules = document.getElementById('noSchedules');
    
    if (!currentTasks || currentTasks.length === 0) {
      showNoTasks();
      return;
    }
    
    noSchedules.style.display = 'none';
    
    let html = '';
    currentTasks.forEach((task) => {
      const createTime = new Date(task.created_at).toLocaleString('zh-CN');
      const updateTime = new Date(task.updated_at).toLocaleString('zh-CN');
      const scheduledDate = task.scheduled_date;
      
      html += `
        <tr>
          <td>${task.task_id}</td>
          <td>${task.title}</td>
          <td>${getPriorityLabel(task.priority)}</td>
          <td>${getStatusLabel(task.status)}</td>
          <td>${createTime}</td>
          <td>${scheduledDate}</td>
          <td>
            <div class="action-buttons">
              ${task.status === 'pending' ? 
                `<button class="action-btn complete-btn" onclick="completeTask(${task.task_id})">完成</button>` :
                ''
              }
              <button class="action-btn edit-btn" onclick="editTask(${task.task_id})">修改</button>
              <button class="action-btn delete-btn" onclick="deleteTask(${task.task_id})">删除</button>
            </div>
          </td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  }
  
  // 完成任务
  async function completeTask(taskId) {
    if (!confirm('确认完成此任务吗？')) return;
    
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/user/api/tasks/${taskId}/complete`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        alert('任务已完成');
        await loadTasks();
        if (window.calendar) {
          window.calendar.refetchEvents();
        }
      } else {
        alert('操作失败: ' + data.message);
      }
    } catch (error) {
      console.error('完成任务失败:', error);
      alert('操作失败，请重试');
    }
  }
  
  // 删除任务
  async function deleteTask(taskId) {
    if (!confirm('确认删除此任务吗？此操作不可撤销。')) return;
    
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/user/api/tasks/${taskId}/delete`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        alert('删除成功');
        currentTasks = currentTasks.filter(task => task.task_id !== taskId);
        renderScheduleTable();
        if (window.calendar) {
          window.calendar.refetchEvents();
        }
      } else {
        alert('删除失败: ' + data.message);
      }
    } catch (error) {
      console.error('删除任务失败:', error);
      alert('删除失败，请重试');
    }
  }
  
  // 编辑任务
  async function editTask(taskId) {
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    if (!userInfo) {
      alert('请先登录');
      return;
    }
    try {
      const token = localStorage.getItem('token');
      const url = `/user/api/tasks/${taskId}?user_id=${userInfo.user_id}`;
      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        const task = data.data;
        if (task) {
          isEditing = true;
          currentEditingId = taskId;
          
          document.getElementById('modalTitle').textContent = '编辑任务';
          document.getElementById('taskId').value = task.task_id;
          document.getElementById('title').value = task.title;
          document.getElementById('eventDate').value = task.scheduled_date;
          //document.getElementById('description').value = task.description || '';
          document.getElementById('priority').value = task.priority;
          
          openModal();
        } else {
          alert('未找到该任务');
        }
      } else {
        alert('加载任务失败: ' + data.message);
      }
    } catch (error) {
      console.error('编辑任务失败:', error);
      alert('加载任务失败，请重试');
    }
  }
  
  // 打开添加模态框
  function openAddModal(dateStr) {
    isEditing = false;
    currentEditingId = null;
    
    document.getElementById('modalTitle').textContent = '添加新任务';
    document.getElementById('scheduleForm').reset();
    document.getElementById('taskId').value = '';
    
    if (dateStr) {
      document.getElementById('eventDate').value = dateStr.split('T')[0];
    } else {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('eventDate').value = today;
    }
    
    openModal();
  }
  
  // 打开模态框
  function openModal() {
    document.getElementById('scheduleModal').style.display = 'block';
  }
  
  // 关闭模态框
  function closeModal() {
    document.getElementById('scheduleModal').style.display = 'none';
    isEditing = false;
    currentEditingId = null;
  }
  
  // 保存任务（创建或更新）
  async function saveTask(taskData) {
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    if (!userInfo) {
      throw new Error('未登录，无法保存任务');
    }

    const payload = {
    ...taskData,
    user_id: userInfo.user_id  // ← 关键：加到 body 里
    };

    const url = isEditing 
      ? `/user/api/tasks/${currentEditingId}/update`
      : `/user/api/tasks/create`;

    const method = isEditing ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload),
      credentials: 'same-origin' // 
    });

    return await response.json();
  }
  
  // 绑定事件
  function bindEvents() {
    // 添加任务按钮
    document.getElementById('addScheduleBtn').addEventListener('click', () => {
      openAddModal();
    });
    
    // 关闭模态框按钮
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    
    // 点击模态框外部关闭
    document.getElementById('scheduleModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('scheduleModal')) {
        closeModal();
      }
    });
    
    // 表单提交
    document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const taskData = {
        title: document.getElementById('title').value.trim(),
        scheduled_date: document.getElementById('eventDate').value,
        //description: document.getElementById('description').value.trim(),
        priority: document.getElementById('priority').value
      };
      
      if (!taskData.title) {
        alert('请输入标题');
        return;
      }
      
      if (!taskData.scheduled_date) {
        alert('请选择日期');
        return;
      }
      
      try {
        const result = await saveTask(taskData);
        
        if (result.code === 201 || result.code === 200) {
          alert(isEditing ? '更新成功' : '添加成功');
          closeModal();
          await loadTasks();
          if (window.calendar) {
            window.calendar.refetchEvents();
          }
        } else {
          alert((isEditing ? '更新失败' : '添加失败') + ': ' + result.message);
        }
      } catch (error) {
        console.error('保存任务失败:', error);
        alert('保存失败，请重试');
      }
    });
  }
</script>
</body>
</html>